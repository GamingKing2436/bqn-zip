Deflateâ†(â€¢Import"deflate.bqn").Deflate
LEintâ†{ğ•Šğ•©:Ã—âŸœ256âŠ¸+ËœÂ´ğ•©;ğ•¨ğ•Šâ¼ğ•©:256|>âŒŠâˆ˜Ã·`((ğ•¨âŠ£4)â¥Š256)Â»Ëœğ•©}

mâ‡{âŸ¨cdfh,lfh,eocd,ddâŸ©â‡@+<Ë˜80â€¿75âˆ¾â‰1âˆ˜â€¿2â¥Š1+â†•8} # magic bytes
fieldâ‡{
   eocdâ‡4â€¿2â€¿2â€¿2â€¿2â€¿4â€¿4â€¿2
   cdfhâ‡4â€¿2â€¿2â€¿2â€¿2â€¿2â€¿2â€¿4â€¿4â€¿4â€¿2â€¿2â€¿2â€¿2â€¿2â€¿4â€¿4
   lfh â‡4â€¿  2â€¿2â€¿2â€¿2â€¿2â€¿4â€¿4â€¿4â€¿2â€¿2
   
   cdtlâ‡1â€¿0â€¿1â€¿1â€¿1â€¿1â€¿1â€¿1â€¿1â€¿1â€¿1â€¿1â€¿0â€¿0â€¿0â€¿0â€¿0â€¿1â€¿1â€¿0 # cdfh to lfh bitmap
}


# constâ‡{keyâ‡{
#    eocdâ‡{âŸ¨sig,disknum,cddisk,cddiskcount,cdcount,cdsize,cd,commentlen,commentâŸ©â‡â†•9}
#    cdfhâ‡{âŸ¨sig,version,minversion,flags,compressiontype,mtime,mdate,crc32,compressedsize,size,namelen,extrafieldlen,commentlen,disk,internalattr,externalattr,fileoffset,name,extrafield,commentâŸ©â‡â†•20}
#    lfh â‡{âŸ¨sig,       ,minversion,flags,compressiontype,mtime,mdate,crc32,compressedsize,size,namelen,extrafieldlen,                                                    ,name,extrafield,       âŸ©â‡â†•13}
# }}

EOCDâ‡{ğ•Šğ•©: # End of central directory record
   oâ†field.eocd/âŠ¸âŠ”22â†‘ğ•©
   "Error: not a zip file"!m.eocdâ‰¡âŠ‘o
   
   (LEintÂ¨-âŸœ@)âŒ¾(1âŠ¸â†“)o
   ;ğ•Šâ¼ğ•©: # to write
   âˆ¾(field.eocd +âŸœ@âˆ˜(LEintâ¼Â¨)âŒ¾(1âŠ¸â†“) âŠ¢)âŒ¾(8âŠ¸â†‘) ğ•©
}
CDFHâ‡{ğ•Šğ•©: # Central directory file header
   oâ†field.cdfh/âŠ¸âŠ”46â†‘ğ•©
   "Error: cdfh signature missing"!m.cdfhâ‰¡âŠ‘o
   oâ†©(LEintÂ¨-âŸœ@)âŒ¾(1âŠ¸â†“)o
   âŸ¨name,extrafield,commentâŸ©â†Â»âŸœ""â€¿""â€¿""(10â€¿11â€¿12âŠo)/âŠ¸(âŠ£âŠ”â‰ âŠ¸â†‘)46â†“ğ•©
   
   oâˆ¾âŸ¨name,extrafield,commentâŸ©
   ;ğ•Šâ¼ğ•©: # to write
   âˆ¾(field.cdfh +âŸœ@âˆ˜(LEintâ¼Â¨)âŒ¾(1âŠ¸â†“) âŠ¢)âŒ¾(17âŠ¸â†‘) ğ•©
}
LFHâ‡{ğ•Šğ•©: # Local file header
   oâ†field.lfh/âŠ¸âŠ”30â†‘ğ•©
   "Error: lfh signature missing"!m.lfhâ‰¡âŠ‘o
   oâ†©(LEintÂ¨-âŸœ@)âŒ¾(1âŠ¸â†“)o
   âŸ¨name,extrafieldâŸ©â†Â»âŸœ""â€¿""(9â€¿10âŠo)/âŠ¸(âŠ£âŠ”â‰ âŠ¸â†‘)30â†“ğ•©
   oâ†©o DDËœ Â¯16â†‘ğ•©
   
   oâˆ¾âŸ¨name,extrafieldâŸ©
   ;ğ•Šâ¼ğ•©: # to write
   âˆ¾(field.lfh +âŸœ@âˆ˜(LEintâ¼Â¨)âŒ¾(1âŠ¸â†“) âŠ¢)âŒ¾(11âŠ¸â†‘) ğ•©
}

DDâ‡{ğ•¨ğ•Šğ•©: # Data descriptor
   crc32â€¿compressedsizeâ€¿sizeâ†6â€¿7â€¿8âŠğ•©
   "Error: crc32 is not null when data descriptor present"!0=crc32
   "Error: sizes are not empty when data descriptor present"!âˆ¨Â´âˆŠâŸœâŸ¨0,Â¯1+2â‹†32âŸ©compressedsizeâ€¿size
   "NYIError: zip64"âˆ¨Â´(Â¯1+2â‹†32)=compressedsizeâ€¿size
   ddfieldâ†âŸ¨4âŒ¾Ã—m.ddâ‰¡4â†‘ğ•¨,4,4,4âŸ©
   newâ†1â†“ddfield/âŠ¸âŠ”(+Â´ddfield)â†‘ğ•¨
   
   newâŒ¾(6â€¿7â€¿8âŠ¸âŠ)ğ•©
}âŸ(2âŠ¸|Â·Ã·âŸœ8 2âŠ‘âŠ¢) # check flag

ParseCDâ‡{countğ•Šğ•©:
   ğ•©{ğ•©+46+Â´LEintË˜âˆ˜â€¿2â¥Šğ•¨âŠËœ(28+â†•6)+ğ•©}âŸ(1+â†•count)0
}

FindEOCDâ‡(Â¯1âŠ‘Â·/m.eocdâ·âŠ¢)

Decompressâ‡{ # ğ•¨ is compression method, ğ•© is the compressed data
   ğ•Šâ¼ğ•©:Deflate ğ•©
   ;0â€¿crcâ€¿sizeğ•Šğ•©:ğ•©
   ;8â€¿crcâ€¿sizeğ•Šğ•©: crcâ€¿size Deflateâ¼ ğ•©
   ;ğ•¨ğ•Šğ•©:!"Error: Unknown compression type: "âˆ¾â€¢Reprğ•¨
}
Packâ‡{
   ğ•Šâ¼ğ•©:
   eocd_bytesâ†(FindEOCDâ†“âŠ¢)ğ•©
   ziâ†EOCD eocd_bytes # zip info
   commentâ†eocd_bytesâ†‘Ëœ-Â¯1âŠ‘zi
   "NYIError: multipart archive"!0â€¿0â‰¡1â€¿2âŠzi # disk number better be 0
   "NYIError: multipart archive"!â‰¡Â´3â€¿4âŠzi # every cdfh should be on the same disk
   countâ€¿sizeâ€¿startâ†4â€¿5â€¿6âŠzi
   cdfhiâ†sizeâ†‘startâ†“ğ•© # cdfh info
   fileiâ†â‰>CDFHÂ¨cdfhiâŠ”Ëœ+`/â¼count ParseCD -âŸœ@ cdfhi # file info
   "NYIError: multipart archive"!âˆ§Â´0=13âŠfilei # disk number better be 0
   fcsizeâ€¿fsizeâ€¿namelenâ€¿exlenâ€¿fstartâ†<Ë˜8â€¿9â€¿10â€¿11â€¿16âŠfilei
   filesâ†(30+namelen+exlen+fcsize+16)â†‘Â¨fstartâ†“Â¨<ğ•© # 16 to account for possible data descriptor
   "Error: central directory file header and local file header don't match"!(field.cdtl/filei)â‰¡â—‹(1âŠ¸â†“)â‰>LFHÂ¨files # compare filei and lfilei
   filedataâ†fcsizeâ†‘Â¨(30+namelen+exlen)â†“Â¨files
   
   âŸ¨comment,fileiâˆ¾filedataâŸ©
   ;ğ•Šcommentâ€¿filei:commentğ•Šfilei
   ;ğ•Šğ•©:""ğ•Šğ•©
   ;commentğ•Šğ•©:
   filesâ†(Â¯1âŠğ•©)âˆ¾Â¨ËœLFHÂ¨â¼m.lfhâŒ¾âŠ‘Â¨<Ë˜â‰â¼field.cdtl/Â¯1â†“ğ•©
   cdfhisâ†CDFHÂ¨â¼<Ë˜â‰â¼(+`Â»â‰ Â¨files)âŒ¾(16âŠ¸âŠ)Â¯1â†“ğ•© # fix file offsets and unparse
   ziâ†âŸ¨m.eocd,0,0,â‰ cdfhis,â‰ cdfhis,â‰ âˆ¾cdfhis,+Â´â‰ Â¨files,â‰ commentâŸ©
   âˆ¾âŸ¨âˆ¾files,âˆ¾cdfhis,EOCDâ¼zi,commentâŸ©
}
Zipâ‡{
   ğ•Šâ¼ğ•©:
   commentâ€¿fileiâ†Packâ¼ğ•©
   file_contentsâ†((<Ë˜Â·â‰4â€¿7â€¿9âŠâŠ¢) DecompressÂ¨Â¯1âŠ¸âŠ) filei # compressiontypeâ€¿crc32â€¿size
   
   (17âŠfilei)â‰file_contents
   ;ğ•Šcommentâ€¿filei:commentğ•Šfilei
   ;ğ•Šğ•©:""ğ•Šğ•©
   ;commentğ•Šğ•©:
   crcâ€¿sizeâ€¿dataâ€¿compressiontypeâ€¿nameâ†<Ë˜ âˆ¾âŸœ<Â´âŒ¾(1âŠ¸â†‘)âŸ3Ë˜âŒ¾â‰ (âŠ¢(âŠ¢â—¶âŸ¨0â€¿0âŠ¸â‹ˆËœ,Decompressâ¼âˆ˜âŠ£âŸ©Â¨â‹ˆÂ¨8âŠ¸Ã—)'/'â‰ Â¯1âŠ‘Â¨âŠ£)âŒ¾âŠâŸœâŒ½ğ•©
   
   fileiâ†>(1âŠ¸âŠ‘âŸœâ‰¢ğ•©)â¥ŠÂ¨âŸ¨<m.cdfh,0,10,0,compressiontype, 0,0, crc,compressedsizeâ†â‰ Â¨data,size,namelenâ†â‰ Â¨name,0,0,0, 0,16âˆ§'/'=Â¯1âŠ‘Â¨name,46+namelen+compressedsize, name,<"",<""âŸ©
   Pack fileiâˆ¾data
}
Unpackâ‡Packâ¼
Unzipâ‡Zipâ¼
